# ğŸ”’ æ•¸æ“šåº«é·ç§»å®‰å…¨æ€§èªªæ˜

## âœ… å®‰å…¨æ€§ä¿è­‰

### ä¸æœƒè¦†è“‹ç¾æœ‰æ•¸æ“š

é·ç§»ç³»çµ±è¨­è¨ˆç‚º**å¢é‡æ›´æ–°**ï¼Œä¸æœƒè¦†è“‹æˆ–åˆªé™¤ç¾æœ‰æ•¸æ“šã€‚å®‰å…¨æ©Ÿåˆ¶åŒ…æ‹¬ï¼š

#### 1. **æ™ºèƒ½è·³éæ©Ÿåˆ¶**
```python
# migrate.py æœƒè·³éå·²åŸ·è¡Œçš„é·ç§»
if migration_name in executed_migrations:
    print(f"â­ï¸ è·³éå·²åŸ·è¡Œçš„é·ç§»: {migration_name}")
    continue
```

#### 2. **å®‰å…¨ SQL èªå¥**

æ‰€æœ‰é·ç§»ä½¿ç”¨å®‰å…¨çš„èªæ³•ï¼š

```sql
-- ä½¿ç”¨ IF NOT EXISTS é¿å…é‡è¤‡å‰µå»º
CREATE TABLE IF NOT EXISTS notes (...);

-- ä½¿ç”¨ INSERT IGNORE é¿å…é‡è¤‡æ’å…¥
INSERT IGNORE INTO stocks VALUES (...);

-- æª¢æŸ¥å¾Œå†æ·»åŠ æ¬„ä½
SET @column_exists = (SELECT COUNT(*) FROM ...);
IF @column_exists = 0 THEN
    ALTER TABLE ... ADD COLUMN ...
END IF;
```

#### 3. **äº‹å‹™ä¿è­·**

å¦‚æœé·ç§»å¤±æ•—ï¼Œæœƒè‡ªå‹•å›æ»¾ï¼š

```python
try:
    # åŸ·è¡Œé·ç§»
    cursor.execute(statement)
except Error as e:
    connection.rollback()  # å¤±æ•—æ™‚å›æ»¾
```

## ğŸ“‹ é·ç§»æ–‡ä»¶è§£æ

### 000_initial_schema.sql

**ç›®çš„**ï¼šå‰µå»ºåˆå§‹è¡¨çµæ§‹

**å®‰å…¨æªæ–½**ï¼š
- âœ… `CREATE DATABASE IF NOT EXISTS` - ä¸æœƒè¦†è“‹ç¾æœ‰æ•¸æ“šåº«
- âœ… `CREATE TABLE IF NOT EXISTS` - ä¸æœƒè¦†è“‹ç¾æœ‰è¡¨
- âœ… `INSERT IGNORE` - ä¸æœƒè¦†è“‹ç¾æœ‰æ•¸æ“š

**åŸ·è¡Œæ¢ä»¶**ï¼š
- åªåœ¨æ•¸æ“šåº«å…¨æ–°å®‰è£æ™‚åŸ·è¡Œ
- å¦‚æœè¡¨å·²å­˜åœ¨ä¸”æœ‰æ•¸æ“šï¼Œåªæœƒå‰µå»ºç¼ºå¤±çš„è¡¨
- ç¯„ä¾‹æ•¸æ“šåªåœ¨ç©ºè¡¨æ™‚æ’å…¥

### 001_add_ref_fields.sql

**ç›®çš„**ï¼šæ–°å¢ `ref` å’Œ `ref_time` æ¬„ä½

**å®‰å…¨æªæ–½**ï¼š
- âœ… æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨å¾Œå†æ·»åŠ 
- âœ… æª¢æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨å¾Œå†å‰µå»º
- âœ… åªåœ¨æ¬„ä½ä¸å­˜åœ¨æ™‚åŸ·è¡Œ `ALTER TABLE`

**åŸ·è¡Œæ¢ä»¶**ï¼š
- è‡ªå‹•æª¢æŸ¥æ¬„ä½æ˜¯å¦å·²å­˜åœ¨
- å¦‚æœæ¬„ä½å·²å­˜åœ¨ï¼Œè·³éä¸¦é¡¯ç¤º "æ¬„ä½å·²å­˜åœ¨"
- ä¸æœƒä¿®æ”¹ç¾æœ‰æ¬„ä½çš„å€¼

## ğŸ¯ å¯¦éš›åŸ·è¡Œæµç¨‹

### å ´æ™¯ 1ï¼šå…¨æ–°æ•¸æ“šåº«

```bash
python migrate.py migrate
```

**åŸ·è¡Œéç¨‹**ï¼š
1. âœ… å‰µå»ºæ•¸æ“šåº«ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. âœ… å‰µå»º tablesï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
3. âœ… æ’å…¥ç¯„ä¾‹æ•¸æ“šï¼ˆä½¿ç”¨ INSERT IGNOREï¼‰
4. âœ… æ–°å¢æ¬„ä½å’Œç´¢å¼•
5. âœ… è¨˜éŒ„åˆ° migrations è¡¨

**çµæœ**ï¼šä¹¾æ·¨çš„æ•¸æ“šåº«ï¼Œå¸¶æœ‰ç¯„ä¾‹æ•¸æ“š

### å ´æ™¯ 2ï¼šå·²æœ‰æ•¸æ“šåº«

```bash
python migrate.py migrate
```

**åŸ·è¡Œéç¨‹**ï¼š
1. âœ… æª¢æŸ¥ migrations è¡¨
2. âœ… è·³éå·²åŸ·è¡Œçš„é·ç§»
3. âœ… åªåŸ·è¡Œæ–°çš„é·ç§»
4. âœ… ä½¿ç”¨å®‰å…¨èªå¥ä¸è¦†è“‹ç¾æœ‰æ•¸æ“š

**çµæœ**ï¼šæ•¸æ“šåº«çµæ§‹æ›´æ–°ï¼Œç¾æœ‰æ•¸æ“šä¿ç•™

### å ´æ™¯ 3ï¼šéƒ¨åˆ†åŸ·è¡Œçš„é·ç§»

```bash
python migrate.py migrate
```

**åŸ·è¡Œéç¨‹**ï¼š
1. âœ… è®€å– migrations è¡¨å·²åŸ·è¡Œåˆ—è¡¨
2. âœ… è·³é 000ï¼ˆå·²åŸ·è¡Œï¼‰
3. âœ… åŸ·è¡Œ 001ï¼ˆæ–°å¢æ¬„ä½ï¼Œæª¢æŸ¥å¾Œå†æ·»åŠ ï¼‰
4. âœ… è¨˜éŒ„ 001 ç‚ºå·²åŸ·è¡Œ

**çµæœ**ï¼šæ–°å¢æ¬„ä½ï¼Œä¸å½±éŸ¿ç¾æœ‰æ•¸æ“š

## ğŸ” æª¢æŸ¥é·ç§»ç‹€æ…‹

### æŸ¥çœ‹é·ç§»è¨˜éŒ„

```bash
python migrate.py status
```

**è¼¸å‡ºç¯„ä¾‹**ï¼š
```
ğŸ“Š é·ç§»ç‹€æ…‹:
å·²åŸ·è¡Œ: 2 å€‹
ç¸½è¨ˆ: 2 å€‹
  000_initial_schema.sql: âœ… å·²åŸ·è¡Œ
  001_add_ref_fields.sql: âœ… å·²åŸ·è¡Œ
```

### æŸ¥çœ‹æ•¸æ“šåº«ä¸­çš„é·ç§»è¨˜éŒ„

```sql
-- æŸ¥çœ‹å·²åŸ·è¡Œçš„é·ç§»
SELECT * FROM migrations ORDER BY executed_at;

-- è¼¸å‡ºï¼š
-- id | migration_name           | executed_at       | description
-- 1  | 000_initial_schema.sql   | 2025-01-XX 10:00 | åˆå§‹çµæ§‹
-- 2  | 001_add_ref_fields.sql   | 2025-01-XX 10:05 | æ–°å¢ä¾†æºæ¬„ä½
```

## âš ï¸ æ³¨æ„äº‹é …

### 1. å»ºè­°å‚™ä»½
é›–ç„¶é·ç§»ç³»çµ±å¾ˆå®‰å…¨ï¼Œä½†å»ºè­°åœ¨åŸ·è¡Œå‰å‚™ä»½ï¼š

```bash
mysqldump -u username -p stock_note_project > backup.sql
```

### 2. æ¸¬è©¦ç’°å¢ƒ
å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰é·ç§»ï¼š

```bash
# åœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œ
python migrate.py status
python migrate.py migrate
```

### 3. æŸ¥çœ‹æ—¥èªŒ
é·ç§»åŸ·è¡Œéç¨‹æœƒé¡¯ç¤ºè©³ç´°æ—¥èªŒï¼š

```bash
python migrate.py migrate

# è¼¸å‡ºç¯„ä¾‹ï¼š
# âœ… é·ç§»è¨˜éŒ„è¡¨å·²å‰µå»ºæˆ–å·²å­˜åœ¨
# ğŸ“‹ å·²åŸ·è¡Œçš„é·ç§»: ['000_initial_schema.sql']
# ğŸ”„ åŸ·è¡Œé·ç§»: 001_add_ref_fields.sql
# âœ… é·ç§»åŸ·è¡ŒæˆåŠŸ: 001_add_ref_fields.sql
```

## ğŸ‰ ç¸½çµ

**é·ç§»ç³»çµ±ä¸æœƒè¦†è“‹ç¾æœ‰æ•¸æ“š**ï¼Œå› ç‚ºï¼š

1. âœ… ä½¿ç”¨ `IF NOT EXISTS` èªå¥
2. âœ… æ™ºèƒ½è·³éå·²åŸ·è¡Œçš„é·ç§»
3. âœ… æª¢æŸ¥å¾Œå†åŸ·è¡Œ `ALTER TABLE`
4. âœ… ä½¿ç”¨ `INSERT IGNORE` é¿å…é‡è¤‡æ’å…¥
5. âœ… å¤±æ•—æ™‚è‡ªå‹•å›æ»¾

**å¯ä»¥æ”¾å¿ƒåŸ·è¡Œ**ï¼š
```bash
python migrate.py migrate
```

